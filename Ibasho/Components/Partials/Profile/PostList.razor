@*
    投稿一覧コンポーネント
*@
@rendermode InteractiveServer

@using Ibasho.Application.UseCases.Profiles
@using Ibasho.Application.UseCases.Users
@using Ibasho.Components.Partials.Shared
@using Ibasho.Application.DTOs
@using Ibasho.Application.Services.Auth
@using Microsoft.AspNetCore.Components.Authorization
@inject GetUserPostsUseCase GetUserPostsUseCase
@inject GetUserIdUseCase GetUserIdUseCase
@inject AuthenticationStateProvider AuthStateProvider

@* タブ *@
<div class="border-t border-gray-200">
    <TabSelect Tabs="@TabNames" ActiveTab="@ActiveTab" OnTabChanged="HandleTabChanged" />
</div>
@* 投稿一覧 *@
<div class="space-y-3 mt-4">
    @if (Posts == null || Posts.Count == 0)
    {
        <div class="text-gray-500 text-center py-8">投稿はまだありません</div>
    }
    else
    {
        <div class="space-y-4">
            @foreach (var post in Posts)
            {
                <PostItem Post="post" />
            }
        </div>
    }
</div>

@code {
    // 表示用ユーザId
    [Parameter] public string DisplayUserId { get; set; } = "";

    // 投稿一覧
    private IReadOnlyList<PostListItemDto>? Posts;

    // タブ名
    private List<string> TabNames = new() { "投稿", "いいね" };

    // アクティブタブ
    public string ActiveTab { get; set; } = "投稿";

    /// <summary>
    /// 初期表示時
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        await GetProfileAsync();
    }

    /// <summary>
    /// タブ変更時
    /// </summary>
    /// <param name="changedTab">変更後のタブ</param>
    /// <returns></returns>
    private async Task HandleTabChanged(string changedTab)
    {
        ActiveTab = changedTab;
        if (changedTab == TabNames[0])
        {
            await GetProfileAsync();
        }
        else
        {
            Posts = [];
            StateHasChanged();
        }
    }

    /// <summary>
    /// プロフィール情報取得
    /// </summary>
    public async Task GetProfileAsync()
    {
        string? myUserId = await UserAuthHelper.GetUserIdAsync(AuthStateProvider);
        if (string.IsNullOrEmpty(myUserId))
        {
            return;
        }
        string? targetUserId = await GetUserIdUseCase.ExecuteAsync(DisplayUserId);
        if (string.IsNullOrEmpty(targetUserId))
        {
            return;
        }

        Posts = await GetUserPostsUseCase.ExecuteAsync(targetUserId, myUserId);
        StateHasChanged();
    }
}
