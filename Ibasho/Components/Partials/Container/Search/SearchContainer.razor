@*
    検索コンテナー
*@
@rendermode InteractiveServer
@using Ibasho.Application.Services.BrowserStorage
@inject ISessionStorageService SessionStorage

<div class="space-y-4">
    @if (!IsCashGetting)
    {
        @* 検索フォーム *@
        <div class="relative">
            <input type="text" @bind="State.Keyword" @bind:event="oninput" @onkeydown="HandleKeyDown" placeholder="キーワードで検索" class="w-full pl-10 pr-4 py-2 border rounded-full bg-gray-100 focus:outline-none focus:ring-2 focus:ring-sky-400">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>

        @* タブ切替 *@
        <div class="border-b border-gray-200">
            <TabSelect Tabs="@TabNames" ActiveTab="@State.ActiveTab" OnTabChanged="HandleTabChanged" />
        </div>

        @* 検索中表示 *@
        @if (IsSearching)
        {
            <div class="text-center text-gray-500 py-8">検索中...</div>
        }
        else
        {
            @* ユーザー一覧 *@
            @if (State.ActiveTab == "ユーザー")
            {
                @if (State.Users == null || State.Users.Count == 0)
                {
                    <div class="text-center text-gray-500 py-8">
                        @(string.IsNullOrEmpty(State.Keyword) ? "キーワードを入力して検索してください" : "ユーザーが見つかりませんでした")
                    </div>
                }
                else
                {
                    <div class="space-y-3">
                        @foreach (var user in State.Users)
                        {
                            <UserItem User="user" ShowFollowButton="true" />
                        }
                    </div>
                }
            }
            @* 投稿一覧 *@
            else
            {
                @if (State.Posts == null || State.Posts.Count == 0)
                {
                    <div class="text-center text-gray-500 py-8">
                        @(string.IsNullOrEmpty(State.Keyword) ? "キーワードを入力して検索してください" : "投稿が見つかりませんでした")
                    </div>
                }
                else
                {
                    <div class="space-y-3">
                        @foreach (var post in State.Posts)
                        {
                            <PostItem Post="post" />
                        }
                    </div>
                }
            }
        }
    }
</div>

@code {
    // タブ名
    private List<string> TabNames = new() { "ユーザー", "投稿" };

    // 検索画面の状態
    private SearchContainerState State { get; set; } = new();

    // キャッシュ取得中フラグ
    private bool IsCashGetting { get; set; } = true;

    // 検索中フラグ
    private bool IsSearching { get; set; } = false;

    /// <summary>
    /// 初回レンダリング後にブラウザストレージから復元
    /// </summary>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RestoreStateAsync();
            StateHasChanged();
        }
    }

    /// <summary>
    /// ブラウザストレージから状態を復元
    /// </summary>
    private async Task RestoreStateAsync()
    {
        SearchContainerState? cached = await SessionStorage.GetAsync<SearchContainerState>(SearchContainerState.CacheKey);
        if (cached == null)
        {
            State = new();
        }
        else
        {
            State = cached;
        }
        IsCashGetting = false;
    }

    /// <summary>
    /// 状態をブラウザストレージに保存
    /// </summary>
    private async Task SaveStateAsync()
    {
        await SessionStorage.SetAsync(SearchContainerState.CacheKey, State);
    }

    /// <summary>
    /// キーダウンイベント（Enterで検索）
    /// </summary>
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchAsync();
        }
    }

    /// <summary>
    /// タブ変更時
    /// </summary>
    private async Task HandleTabChanged(string tab)
    {
        State.ActiveTab = tab;
        await SaveStateAsync();
        if (!string.IsNullOrWhiteSpace(State.Keyword))
        {
            await SearchAsync();
        }
    }

    /// <summary>
    /// 検索実行
    /// </summary>
    private async Task SearchAsync()
    {
        if (string.IsNullOrWhiteSpace(State.Keyword))
        {
            State.Users = [];
            State.Posts = [];
            await SaveStateAsync();
            return;
        }

        IsSearching = true;
        StateHasChanged();

        try
        {
            string? userId = await UserAuthHelper.GetUserIdAsync(AuthStateProvider);
            if (string.IsNullOrEmpty(userId))
            {
                return;
            }

            if (State.ActiveTab == "ユーザー")
            {
                State.Users = await SearchUsersUseCase.ExecuteAsync(State.Keyword, userId);
            }
            else
            {
                State.Posts = await SearchPostsUseCase.ExecuteAsync(State.Keyword, userId);
            }

            // 検索結果をブラウザストレージに保存
            await SaveStateAsync();
        }
        finally
        {
            IsSearching = false;
            StateHasChanged();
        }
    }
}
