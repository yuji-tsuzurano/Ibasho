@*
    ホームコンテナー
*@
@rendermode InteractiveServer
@using Ibasho.Application.Services.BrowserStorage
@inject ISessionStorageService SessionStorage

<div class="space-y-4">
    @* 投稿フォーム + 投稿一覧 *@
    <PostList Posts="@State.Posts" OnPostSubmit="@HandlePostSubmit" />
</div>

@code {
    // 投稿一覧
    [Parameter] public List<PostListItemDto> Posts { get; set; } = new();

    // ホーム画面の状態
    private HomeContainerState State { get; set; } = new();

    /// <summary>
    /// パラメーター設定時
    /// </summary>
    protected override void OnParametersSet()
    {
        State.Posts = Posts;
    }

    /// <summary>
    /// 投稿一覧再取得
    /// </summary>
    private async Task ReloadPostsAsync()
    {
        string? userId = await UserAuthHelper.GetUserIdAsync(AuthStateProvider);
        if (string.IsNullOrEmpty(userId))
        {
            State.Posts = new List<PostListItemDto>();
            return;
        }
        State.Posts = (await GetHomeTimelineUseCase.ExecuteAsync(userId)).ToList();
        StateHasChanged();
    }

    /// <summary>
    /// 投稿送信時のコールバック
    /// </summary>
    private async Task HandlePostSubmit(string content)
    {
        string? userId = await UserAuthHelper.GetUserIdAsync(AuthStateProvider);
        if (string.IsNullOrEmpty(userId))
        {
            throw new InvalidOperationException("認証情報が取得できません。");
        }
        await CreatePostUseCase.ExecuteAsync(userId, content);
        await ReloadPostsAsync();
    }
}
