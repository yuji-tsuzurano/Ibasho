@*
    返信コンテナー
*@
@rendermode InteractiveServer
@using Ibasho.Application.Services.BrowserStorage
@inject ISessionStorageService SessionStorage

<div class="space-y-4">
    @* 元投稿 *@
    @if (State.ParentPost != null)
    {
        <PostItem Post="@State.ParentPost" />
    }
    else
    {
        <div class="p-4 text-center text-gray-500">投稿が見つかりません</div>
    }

    @* 返信フォーム + 返信一覧 *@
    <PostList Mode="Reply" Posts="@State.Posts" OnPostSubmit="@HandleReplySubmit" />
</div>

@code {
    // 親投稿ID
    [Parameter] public long ParentPostId { get; set; } = 0;

    // 親投稿（Pageから渡される）
    [Parameter] public PostListItemDto? ParentPost { get; set; }

    // 返信一覧（Pageから渡される）
    [Parameter] public List<PostListItemDto> Posts { get; set; } = new();

    // 返信画面の状態
    private ReplyContainerState State { get; set; } = new();

    /// <summary>
    /// パラメーター設定時
    /// </summary>
    protected override void OnParametersSet()
    {
        State.ParentPost = ParentPost;
        State.Posts = Posts;
    }

    /// <summary>
    /// データ再取得
    /// </summary>
    private async Task ReloadDataAsync()
    {
        string? userId = await UserAuthHelper.GetUserIdAsync(AuthStateProvider);
        if (string.IsNullOrEmpty(userId))
        {
            State.Posts = new List<PostListItemDto>();
            return;
        }
        var (parent, replies) = await GetThreadUseCase.ExecuteAsync(ParentPostId, userId);
        State.ParentPost = parent;
        State.Posts = replies.OrderByDescending(x => x.CreatedAt).ToList();
        StateHasChanged();
    }

    /// <summary>
    /// 返信送信時のコールバック
    /// </summary>
    /// <param name="content">返信内容</param>
    private async Task HandleReplySubmit(string content)
    {
        string? userId = await UserAuthHelper.GetUserIdAsync(AuthStateProvider);
        if (string.IsNullOrEmpty(userId))
        {
            throw new InvalidOperationException("認証情報が取得できません。");
        }
        await CreateReplyUseCase.ExecuteAsync(userId, ParentPostId, content);
        await ReloadDataAsync();
    }
}
